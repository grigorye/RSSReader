<?xml version="1.0" encoding="UTF-8"?>
<!doctype html>
<html>
	<head>
		<style type="text/css">
			h2 {
				font: -apple-system-headline;
			}
			body {
				font: -apple-system-body;
				zoom: 1.2;
			}
			img {
				width: auto;
				height : auto;
				max-height: 100%;
				max-width: 100%;
			}
		</style>
	</head>
	<body>
		<h2>Swift imports fixed-size C arrays as tuples</h2>
		<p><em>This is a follow-up on <a href="https://oleb.net/blog/2017/12/fixed-size-arrays/" title="A hack for fixed-size arrays in Swift">yesterday’s article about using a tuple to mimic a stack-allocated array</a>. Please read that one first if you haven’t already.</em></p> 
 
<p>Yesterday, we saw how you can obtain a pointer to a tuple’s underlying memory and treat it as a collection. Today, I’d like to discuss how we can use the same approach when interfacing with C APIs that work with fixed-size arrays.</p> 
 
<h1>Swift imports fixed-size C arrays as tuples</h1> 
 
<p>The Swift equivalent of the C type <code>float[4]</code> would be <code>(Float, Float, Float, Float)</code>. This has the benefit of incurring no bridging overhead because the Swift compiler can lay out tuples in a C-compatible way.</p> 
 
<p>A tuple often isn’t a convenient type for the user of the API, though — as we’ve seen, you can’t iterate over a tuple’s elements or access one via subscripting.</p> 
 
<h1>Example: <code>char[256]</code> 
</h1> 
 
<p>Let’s look at an example. The <a href="https://developer.apple.com/legacy/library/documentation/Darwin/Reference/ManPages/man3/uname.3.html"><code>uname</code></a> function returns some strings identifying the current platform. You call <code>uname</code> by passing it a pointer to a struct which <code>uname</code> then fills with values. The struct is defined like this in C:</p> 
 
<div><pre><code><span>struct</span> <span>utsname</span> <span>{</span> 
  <span>char</span> <span>sysname</span><span>[</span><span>256</span><span>];</span>  <span>/* [XSI] Name of OS */</span> 
  <span>char</span> <span>nodename</span><span>[</span><span>256</span><span>];</span> <span>/* [XSI] Name of this network node */</span> 
  <span>char</span> <span>release</span><span>[</span><span>256</span><span>];</span>  <span>/* [XSI] Release level */</span> 
  <span>char</span> <span>version</span><span>[</span><span>256</span><span>];</span>  <span>/* [XSI] Version level */</span> 
  <span>char</span> <span>machine</span><span>[</span><span>256</span><span>];</span>  <span>/* [XSI] Hardware type */</span> 
<span>};</span> 
</code></pre></div> 
<p>You know what’s coming next, right? Swift’s <a href="https://swift.org/compiler-stdlib/#compiler-architecture">Clang importer</a> sees the <code>char[256]</code> declarations and turns them into 256-tuples(!). This is how the same type appears in Swift (feel free to count the number of elements):</p> 
 
<div><pre><code><span>public</span> <span>struct</span> <span>utsname</span> <span>{</span> 
    <span>public</span> <span>var</span> <span>sysname</span><span>:</span>  <span>(</span><span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>,</span> <span>Int8</span><span>)</span> <span>/* [XSI] Name of OS */</span> 
    <span>public</span> <span>var</span> <span>nodename</span><span>:</span> <span>(</span><span>Int8</span><span>,</span> <span>/* ... 254 more ... */</span><span>,</span> <span>Int8</span><span>)</span> <span>/* [XSI] Name of this network node */</span> 
    <span>public</span> <span>var</span> <span>release</span><span>:</span>  <span>(</span><span>Int8</span><span>,</span> <span>/* ... 254 more ... */</span><span>,</span> <span>Int8</span><span>)</span> <span>/* [XSI] Release level */</span> 
    <span>public</span> <span>var</span> <span>version</span><span>:</span>  <span>(</span><span>Int8</span><span>,</span> <span>/* ... 254 more ... */</span><span>,</span> <span>Int8</span><span>)</span> <span>/* [XSI] Version level */</span> 
    <span>public</span> <span>var</span> <span>machine</span><span>:</span>  <span>(</span><span>Int8</span><span>,</span> <span>/* ... 254 more ... */</span><span>,</span> <span>Int8</span><span>)</span> <span>/* [XSI] Hardware type */</span> 
<span>}</span> 
</code></pre></div> 
<p>Calling <code>uname</code> on macOS is as simple as this:</p> 
 
<div><pre><code><span>import</span> <span>Darwin</span> 
<span>var</span> <span>utsInfo</span> <span>=</span> <span>utsname</span><span>()</span> 
<span>uname</span><span>(</span><span>&amp;</span><span>utsInfo</span><span>)</span> 
</code></pre></div> 
<p>But how do you then proceed to extract the information in the <code>utsInfo</code> struct? <code>utsInfo.machine</code> is a 256-tuple of integers, so it’s unusable in its current form:</p> 
 
<div><pre><code><span>print</span><span>(</span><span>utsInfo</span><span>.</span><span>machine</span><span>)</span> 
<span>// → (120, 56, 54, 95, 54, 52, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)</span> 
</code></pre></div> 
<h2>Using <code>_FixedArray256</code> 
</h2> 
 
<p>One approach is to generate a <code>_FixedArray256</code> type as I showed yesterday. You can then pass one of the fields in <code>utsInfo</code> directly to the <code>_FixedArray256</code> initializer. From then on, you have the full <a href="https://developer.apple.com/documentation/swift/collection"><code>Collection</code></a> API at your disposal to work with the data:</p> 
 
<div><pre><code><span>// Assuming we have generated a _FixedArray256 type</span> 
<span>let</span> <span>machine</span> <span>=</span> <span>_FixedArray256</span><span>(</span><span>storage</span><span>:</span> <span>utsInfo</span><span>.</span><span>machine</span><span>)</span> 
</code></pre></div> 
<p>This is probably the way to go if you’re dealing with smaller arrays of numbers etc., but in this particular case there are two significant downsides to this approach:</p> 
 
<ol><li> 
    <p><strong>256 elements is a pretty big tuple, and the impact on code size and compile times is not negligible.</strong> I did a quick test: my version of <code>_FixedArray256</code> (approximately 1,600 lines of generated Swift code) takes about 8 seconds to compile and adds nearly 750 KB to the compiled binary (with optimizations enabled). The convenience doesn’t come for free.</p> 
  </li> 
  <li> 
    <p>The second problem only applies to APIs that return strings. The strings the <code>uname</code> functions writes into the struct are actually null-terminated — the length of 256 bytes is just an upper limit. As a result, most of the elements in our “array” would contain garbage data and we’d have to process the data further (i.e. strip everything after the first null byte).</p> 
  </li> 
</ol><div> 
  <p><strong><code>_FixedArray256</code> takes about 8 seconds to compile and adds nearly 750 KB to the compiled binary.</strong></p> 
</div> 
 
<h2>Using <code>withUnsafeBytes(of:)</code> directly</h2> 
 
<p>A better approach is to not use <code>_FixedArray256</code> at all. Instead, let’s just take the idea of obtaining a pointer to the tuple’s storage and using that to initialize a string. Since <a href="https://developer.apple.com/documentation/swift/string"><code>String</code></a> already has <a href="https://developer.apple.com/documentation/swift/string/1641523-init">a matching initializer for a null-terminated C string</a>, this can be done in very little code:</p> 
 
<div><pre><code><span>let</span> <span>machine</span> <span>=</span> <span>withUnsafeBytes</span><span>(</span><span>of</span><span>:</span> <span>&amp;</span><span>utsInfo</span><span>.</span><span>machine</span><span>)</span> <span>{</span> <span>(</span><span>rawPtr</span><span>)</span> <span>-&gt;</span> <span>String</span> <span>in</span> 
    <span>let</span> <span>ptr</span> <span>=</span> <span>rawPtr</span><span>.</span><span>baseAddress</span><span>!.</span><span>assumingMemoryBound</span><span>(</span><span>to</span><span>:</span> <span>CChar</span><span>.</span><span>self</span><span>)</span> 
    <span>return</span> <span>String</span><span>(</span><span>cString</span><span>:</span> <span>ptr</span><span>)</span> 
<span>}</span> 
<span>print</span><span>(</span><span>machine</span><span>)</span> <span>// → x86_64</span> 
</code></pre></div> 
<p>This compiles much faster and doesn’t have a significant impact on code size.</p> 
<hr><div> 
  <div> 
    <p><strong>If you liked this article, I bet you’ll also like <a href="https://gumroad.com/a/507458675" title="Advanced Swift at objc.io">Advanced Swift</a></strong>, the book I wrote together with Chris Eidhof and Airspeed Velocity. The third edition, fully updated for Swift 4, is out now.</p> 
    <p><a href="https://gumroad.com/a/507458675" title="Advanced Swift at objc.io">Advanced Swift</a> is available as a DRM-free e-book and in print.</p> 
  </div> 
</div>
	</body>
</html>
