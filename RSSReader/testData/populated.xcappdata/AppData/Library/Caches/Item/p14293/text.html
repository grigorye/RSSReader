<?xml version="1.0" encoding="UTF-8"?>
<!doctype html>
<html>
	<head>
		<style type="text/css">
			h2 {
				font: -apple-system-headline;
			}
			body {
				font: -apple-system-body;
				zoom: 1.2;
			}
			img {
				width: auto;
				height : auto;
				max-height: 100%;
				max-width: 100%;
			}
		</style>
	</head>
	<body>
		<h2>Quick Bits: Closure-based CAAnimationDelegate</h2>
		<p><code>CAAnimation</code> has <del>an informal</del> a formal—as of iOS 10—delegate protocol for informing an object when an animation starts or stops, which is useful in many cases. However, with the advent of blocks and closures, using delegates for this type of thing can be cumbersome, especially if you are managing several animations. UIKit introduced convenient, block-based animation methods, yet Core Animation never did the same. Let’s fix that.</p> 
 
 
 
<p><code>CAAnimation</code> has <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CAAnimation_class/#//apple_ref/doc/uid/TP40004494-CH1-SW13">two functions</a> for responding to animation events: starting and stopping. <code>CAAnimation</code> calls those functions on its delegate, if it exists, during its running lifecycle.</p> 
 
<div><div><pre><code><span>func</span> <span>animationDidStart</span><span>(</span><span>_</span> <span>anim</span><span>:</span> <span>CAAnimation</span><span>)</span> 
<span>func</span> <span>animationDidStop</span><span>(</span><span>_</span> <span>anim</span><span>:</span> <span>CAAnimation</span><span>,</span> <span>finished</span> <span>flag</span><span>:</span> <span>Bool</span><span>)</span> 
</code></pre></div>  </div> 
  CAAnimationDelegate protocol<p>Because animation objects are added to layers, we can create a <code>CALayer</code> extension that declares a couple of convenience functions for adding animations and includes lifecycle closures:</p> 
 
<div><div><pre><code><span>extension</span> <span>CALayer</span> <span>{</span> 
 
    <span>func</span> <span>addAnimation</span><span>(</span><span>_</span> <span>animation</span><span>:</span> <span>CAAnimation</span><span>,</span> <span>forKey</span> <span>key</span><span>:</span> <span>String</span><span>?,</span> <span>completionClosure</span><span>:</span> <span>LayerAnimationCompletionClosure</span><span>?)</span> <span>{}</span> 
    <span>func</span> <span>addAnimation</span><span>(</span><span>_</span> <span>animation</span><span>:</span> <span>CAAnimation</span><span>,</span> <span>forKey</span> <span>key</span><span>:</span> <span>String</span><span>?,</span> <span>beginClosure</span><span>:</span> <span>LayerAnimationBeginClosure</span><span>?,</span> <span>completionClosure</span><span>:</span> <span>LayerAnimationCompletionClosure</span><span>?)</span> <span>{}</span> 
 
<span>}</span> 
</code></pre></div>  </div> 
  Extending CALayer to include closure-based functions for adding animations<p>We can create a private class that acts as the animation’s delegate and holds both <code>LayerAnimationBeginClosure</code> and <code>LayerAnimationCompletionClosure</code>:</p> 
 
<div><div><pre><code><span>fileprivate</span> <span>class</span> <span>LayerAnimationDelegate</span><span>:</span> <span>NSObject</span> <span>{</span> 
 
    <span>var</span> <span>beginClosure</span><span>:</span> <span>LayerAnimationBeginClosure</span><span>?</span> 
    <span>var</span> <span>completionClosure</span><span>:</span> <span>LayerAnimationCompletionClosure</span><span>?</span> 
 
<span>}</span> 
 
<span>extension</span> <span>LayerAnimationDelegate</span> <span>(</span><span>CAAnimationDelegate</span><span>)</span> <span>{</span> 
 
    <span>func</span> <span>animationDidStart</span><span>(</span><span>animation</span><span>:</span> <span>CAAnimation</span><span>)</span> <span>{</span> 
        <span>guard</span> <span>let</span> <span>beginClosure</span> <span>=</span> <span>beginClosure</span> <span>else</span> <span>{</span> <span>return</span> <span>}</span> 
        <span>beginClosure</span><span>(</span><span>animation</span><span>)</span> 
    <span>}</span> 
 
    <span>func</span> <span>animationDidStop</span><span>(</span><span>animation</span><span>:</span> <span>CAAnimation</span><span>,</span> <span>finished</span><span>:</span> <span>Bool</span><span>)</span> <span>{</span> 
        <span>guard</span> <span>let</span> <span>completionClosure</span> <span>=</span> <span>completionClosure</span> <span>else</span> <span>{</span> <span>return</span> <span>}</span> 
        <span>completionClosure</span><span>(</span><span>animation</span><span>,</span> <span>finished</span><span>)</span> 
    <span>}</span> 
 
<span>}</span> 
</code></pre></div>  </div> 
  A private proxy class to act as an animation's delegate<p>Then we can implement the <code>CALayer</code> extension functions we declared above: <sup><a href="https://calayer.com/#fn:1">1</a></sup></p> 
 
<div><div><pre><code><span>extension</span> <span>CALayer</span> <span>{</span> 
 
    <span>func</span> <span>addAnimation</span><span>(</span><span>_</span> <span>animation</span><span>:</span> <span>CAAnimation</span><span>,</span> <span>forKey</span> <span>key</span><span>:</span> <span>String</span><span>?,</span> <span>completionClosure</span><span>:</span> <span>LayerAnimationCompletionClosure</span><span>?)</span> <span>{</span> 
        <span>addAnimation</span><span>(</span><span>animation</span><span>,</span> <span>forKey</span><span>:</span> <span>key</span><span>,</span> <span>beginClosure</span><span>:</span> <span>nil</span><span>,</span> <span>completionClosure</span><span>:</span> <span>completionClosure</span><span>)</span> 
    <span>}</span> 
 
    <span>func</span> <span>addAnimation</span><span>(</span><span>_</span> <span>animation</span><span>:</span> <span>CAAnimation</span><span>,</span> <span>forKey</span> <span>key</span><span>:</span> <span>String</span><span>?,</span> <span>beginClosure</span><span>:</span> <span>LayerAnimationBeginClosure</span><span>?,</span> <span>completionClosure</span><span>:</span> <span>LayerAnimationCompletionClosure</span><span>?)</span> <span>{</span> 
        <span>let</span> <span>animationDelegate</span> <span>=</span> <span>LayerAnimationDelegate</span><span>()</span> 
        <span>animationDelegate</span><span>.</span><span>beginClosure</span> <span>=</span> <span>beginClosure</span> 
        <span>animationDelegate</span><span>.</span><span>completionClosure</span> <span>=</span> <span>completionClosure</span> 
 
        <span>animation</span><span>.</span><span>delegate</span> <span>=</span> <span>animationDelegate</span> 
 
        <span>addAnimation</span><span>(</span><span>animation</span><span>,</span> <span>forKey</span><span>:</span> <span>key</span><span>)</span> 
    <span>}</span> 
<span>}</span> 
</code></pre></div>  </div> 
  Implementing the convenience functions in CALayer<p>Now we have convenient, closure-based access to <code>CAAnimation</code>’s lifecycle functions when we add <code>CALayer</code> animations:</p> 
 
<div><div><pre><code><span>layer</span><span>.</span><span>addAnimation</span><span>(</span><span>animation</span><span>,</span> <span>forKey</span><span>:</span> <span>"positionXAnimation"</span><span>,</span> <span>beginClosure</span><span>:</span> <span>{</span> <span>animation</span> <span>in</span> 
    <span>print</span><span>(</span><span>"My animation (</span><span>\(</span><span>animation</span><span>)</span><span>) began."</span><span>)</span> 
<span>},</span> <span>completionClosure</span><span>:</span> <span>{</span> <span>(</span><span>animation</span><span>,</span> <span>finished</span><span>)</span> <span>in</span> 
    <span>print</span><span>(</span><span>"My animation (</span><span>\(</span><span>animation</span><span>)</span><span>) completed. Did it finish? </span><span>\(</span><span>finished</span><span>)</span><span>"</span><span>)</span> 
<span>})</span> 
</code></pre></div>  </div> 
  Making use of closures to be notified of CALayer animation lifecycle events<p>Here’s a <a href="https://gist.github.com/LucasTizma/688aaa9bb44a2178ec44cf030c74e426">Gist</a> of the code we went over today, along with a few other conveniences:</p> 
 
<pre>400: Invalid request 
</pre> 
<div> 
  <ol><li> 
      <p><code>CAAnimation</code> actually holds a strong reference to its delegate <a href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CAAnimation_class/#//apple_ref/occ/instp/CAAnimation/delegate">per the documentation</a>, so the animation delegate class we initialize <strong>will</strong> stick around long enough to do its job. In fact, that is the reason why <code>CAAnimation</code> breaks the conventional memory management rules for delegate objects: if it was weak, the animation wouldn’t be able to guarantee that its delegate still existed after a potentially lengthy duration. <a href="https://calayer.com/#fnref:1">↩</a></p> 
    </li> 
  </ol></div>
	</body>
</html>
